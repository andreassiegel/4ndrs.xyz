<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Andreas Siegel"><meta name=description content="some guy passionate about IT and other things"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Use Cisco AnyConnect to Connect to a VPN from the Command Line on Mac OS"><meta name=twitter:description content="After moving to a new office location, a lot changed &ndash; including the network setup. Different than before, we have to use Cisco AnyConnect now to connect to the VPN. Still, there are different VPNs depending on what I&rsquo;m working on but everything else is quite different.
First of all, this means I can neither use networksetup nor scutil which I have used in my previous script to manage my VPN any longer."><meta property="og:title" content="Use Cisco AnyConnect to Connect to a VPN from the Command Line on Mac OS"><meta property="og:description" content="After moving to a new office location, a lot changed &ndash; including the network setup. Different than before, we have to use Cisco AnyConnect now to connect to the VPN. Still, there are different VPNs depending on what I&rsquo;m working on but everything else is quite different.
First of all, this means I can neither use networksetup nor scutil which I have used in my previous script to manage my VPN any longer."><meta property="og:type" content="article"><meta property="og:url" content="https://4ndrs.xyz/posts/macos-vpn-command-line-anyconnect/"><meta property="article:published_time" content="2020-11-13T18:39:03+01:00"><meta property="article:modified_time" content="2020-11-13T18:39:03+01:00"><base href=https://4ndrs.xyz/posts/macos-vpn-command-line-anyconnect/><title>Use Cisco AnyConnect to Connect to a VPN from the Command Line on Mac OS · 4ndrs.xyz</title><link rel=canonical href=https://4ndrs.xyz/posts/macos-vpn-command-line-anyconnect/><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.11.2/css/all.css integrity=sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://4ndrs.xyz/css/coder.min.365fc6d23b8b25f2390eead64f5fb2e5b371942dc4ba4f105deb7dd6962de016.css integrity="sha256-Nl/G0juLJfI5DurWT1+y5bNxlC3Euk8QXet91pYt4BY=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://4ndrs.xyz/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://4ndrs.xyz/images/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.69.0"></head><body class=colorscheme-light><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://4ndrs.xyz/>4ndrs.xyz</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars"></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://4ndrs.xyz/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://4ndrs.xyz/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://4ndrs.xyz/categories/>Categories</a></li><li class=navigation-item><a class=navigation-link href=https://4ndrs.xyz/contact/>Contact me</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Use Cisco AnyConnect to Connect to a VPN from the Command Line on Mac OS</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i><time datetime=2020-11-13T18:39:03+01:00>November 13, 2020</time></span>
<span class=reading-time><i class="fas fa-clock"></i>4-minute read</span></div><div class=categories><i class="fas fa-folder"></i><a href=https://4ndrs.xyz/categories/tips-tricks/>Tips & Tricks</a></div><div class=tags><i class="fas fa-tag"></i><a href=https://4ndrs.xyz/tags/cli/>cli</a>
<span class=separator>•</span>
<a href=https://4ndrs.xyz/tags/vpn/>vpn</a>
<span class=separator>•</span>
<a href=https://4ndrs.xyz/tags/keychain/>keychain</a>
<span class=separator>•</span>
<a href=https://4ndrs.xyz/tags/mac/>mac</a>
<span class=separator>•</span>
<a href=https://4ndrs.xyz/tags/cisco/>cisco</a>
<span class=separator>•</span>
<a href=https://4ndrs.xyz/tags/anyconnect/>anyconnect</a></div></div></header><div><p>After moving to a new office location, a lot changed &ndash; including the network setup.
Different than before, we have to use <a href=https://www.cisco.com/c/de_de/products/security/anyconnect-secure-mobility-client>Cisco AnyConnect</a> now to connect to the VPN.
Still, there are different VPNs depending on what I&rsquo;m working on but everything else is quite different.</p><p>First of all, this means I can neither use <code>networksetup</code> nor <code>scutil</code> which I have used in <a href=https://4ndrs.xyz/posts/macos-vpn-command-line/ title="Connect to a VPN from the Command Line on Mac OS">my previous script</a> to manage my VPN any longer.
For obvious reasons, this means my script suddenly became useless.</p><p>My personal requirement is still the same, though: I want to be able to connect to any of the VPNs from the command line (and also disconnect again),
without having to enter a password.
The password should be retrieved from the keychain.</p><p>The good news: The Cisco AnyConnect client comes with a command line interface: <code>/opt/cisco/anyconnect/bin/vpn</code>
Nevertheless, I want it to work exactly as before.
This means: I want using the VPN to be as easy as this:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ vpn list
$ vpn connect <span style=color:#4070a0>&#34;myVPN&#34;</span>
$ vpn status <span style=color:#4070a0>&#34;myVPN&#34;</span>
$ vpn disconnect <span style=color:#4070a0>&#34;myVPN&#34;</span>
</code></pre></div><h2 id=drawback-using-cisco-anyconnect>Drawback using Cisco AnyConnect</h2><p>The AnyConnect CLI requires quite some arguments to connect to the VPN:</p><ul><li>host</li><li>group ID</li><li>user name</li><li>password</li></ul><p>Unfortunately, this does not align with what previously was either configured for the VPN or stored in the keychain,
i.e., we will not be able to connect using just some name of a configured VPN.</p><p>For instance, the following command could be used to connect to a VPN:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ /opt/cisco/anyconnect/bin/vpn -s connect myvpn.example.com &lt;&lt;<span style=color:#4070a0>&#34;EOF&#34;</span>
<span style=color:#40a070>1</span>
myUserAccount@myVPN
mySuperStrongPassword
y
<span style=color:#007020>exit</span>
EOF
</code></pre></div><p>In order to make this work with some name like <code>myVPN</code> as before,
we either need to add some hardcoded stuff to our script, or we add a configuration file similar to the <code>~/.ssh/config</code> for instance.</p><h2 id=set-up-a-vpn-configuration-file>Set up a VPN Configuration File</h2><p>Let&rsquo;s really use the SSH config at <code>~/.ssh/config</code> as an example, and create a config file for our VPNs at <code>~/.vpn/config</code>:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ mkdir ~/.vpn
$ touch ~/.vpn/config
</code></pre></div><p>Then, add something like the following to this file:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>VPN myVPN
    GroupId 1
    User myUserAccount@myVPN
    Host myvpn.example.com
</code></pre></div><p>You will find the <code>GroupId</code> values to use when you start to connect to a VPN via AnyConnect CLI manually:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ /opt/cisco/anyconnect/bin/vpn connect myvpn.example.com
Cisco AnyConnect Secure Mobility Client <span style=color:#666>(</span>version 4.6.00362<span style=color:#666>)</span> .

Copyright <span style=color:#666>(</span>c<span style=color:#666>)</span> <span style=color:#40a070>2004</span> - <span style=color:#40a070>2018</span> Cisco Systems, Inc.  All Rights Reserved.


  &gt;&gt; state: Disconnected
  &gt;&gt; state: Disconnected
  &gt;&gt; notice: Ready to connect.
  &gt;&gt; registered with <span style=color:#007020>local</span> VPN subsystem.
  &gt;&gt; contacting host <span style=color:#666>(</span>myvpn.example.com<span style=color:#666>)</span> <span style=color:#007020;font-weight:700>for</span> login information...
  &gt;&gt; notice: Contacting myvpn.example.com.

  &gt;&gt; Please enter your username and password.
    0<span style=color:#666>)</span> anycon
    1<span style=color:#666>)</span> myVPN
Group: <span style=color:#666>[</span>myVPN<span style=color:#666>]</span>
</code></pre></div><p>You should see some similar output as in the snippet above.</p><p>With the config file at <code>~/.vpn/config</code> we have everything in place to create the VPN connection utility we aim for.
The only missing piece is the password which we will add to the Keychain next.</p><h2 id=add-the-vpn-account-password-to-the-keychain>Add the VPN Account Password to the Keychain</h2><p>At first, we will make sure to have the new credentials available in the login keychain:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ security add-generic-password <span style=color:#4070a0;font-weight:700>\
</span><span style=color:#4070a0;font-weight:700></span>  -D <span style=color:#4070a0>&#34;VPN account password&#34;</span> <span style=color:#4070a0;font-weight:700>\
</span><span style=color:#4070a0;font-weight:700></span>  -s <span style=color:#4070a0>&#34;myVPN&#34;</span> <span style=color:#4070a0;font-weight:700>\
</span><span style=color:#4070a0;font-weight:700></span>  -a <span style=color:#4070a0>&#34;myUserAccount@myVPN&#34;</span> <span style=color:#4070a0;font-weight:700>\
</span><span style=color:#4070a0;font-weight:700></span>  -w <span style=color:#4070a0>&#34;mySuperStrongPassword&#34;</span> <span style=color:#4070a0;font-weight:700>\
</span><span style=color:#4070a0;font-weight:700></span>  -T <span style=color:#4070a0>&#34;/usr/bin/security&#34;</span>
</code></pre></div><ul><li><code>-a</code> specifies your VPN account name (required)</li><li><code>-D</code> specifies the kind of the keychain entry (optional, default is &ldquo;application password&rdquo;)</li><li><code>-s</code> specifies the service name (the name of the keychain entry, required)</li><li><code>-T</code> specifies an application which may access the keychain entry (multiple <code>-T</code> options are possible)</li><li><code>-w</code> specified your VPN account password</li></ul><p>The <code>-s</code> option should match the VPN name from your configuration file because we will use it to retrieve the account password from the keychain.</p><h2 id=create-a-new-utility-script>Create a new Utility Script</h2><p>Next, we will create a utility script that uses the keychain entry we just created:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ <span style=color:#007020>echo</span> <span style=color:#4070a0>&#39;#!/bin/bash&#39;</span> &gt; ~/.vpn/anyVpnConnection.sh <span style=color:#666>&amp;&amp;</span> chmod +x ~/.vpn/anyVpnConnection.sh
</code></pre></div><p>Open the script in an editor, and add this code:</p><script type=application/javascript src=https://gist.github.com/andreassiegel/72f9521d7d6a1e58b4754e38531d136e.js></script><p>With that script, you can particularly use a convenient command to connect to a VPN identified by a configured name and reading the password from the keychain:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ ~/.vpn/anyVpnConnection.sh connect <span style=color:#4070a0>&#34;myVPN&#34;</span>
</code></pre></div><p>Besides that, the <code>stats</code> command from AnyConnect basically is aliased as <code>info</code>.
Every other command will just be passed on to the original AnyConnect CLI.</p><p>Thus, the capabilities are a bit different than with the previous utility script,
and the only actual addition is the more convenient way to connect to a VPN.</p><p>In my mind, that is still worth it, the basic requirements are fulfilled.</p><h3 id=set-an-alias>Set an Alias</h3><p>In order to make it yet another bit nicer and more convenient,
we also add an alias so that we can type <code>vpn</code> instead of <code>~/.vpn/anyVpnConnection.sh</code>.</p><p>Add the following line to the configuration of your shell, e.g., <code>~/.zshrc</code> or <code>~/.bashrc</code>:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#007020>alias</span> <span style=color:#bb60d5>vpn</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;~/.vpn/anyVpnConnection.sh&#34;</span>
</code></pre></div><p>Now, using VPN connections is as easy as this:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ vpn connect <span style=color:#4070a0>&#34;myVPN&#34;</span>
$ vpn status
$ vpn info
$ vpn disconnect
</code></pre></div></div><footer><section class=see-also><h3>See also in Command Line VPN</h3><nav><ul><li><a href=https://4ndrs.xyz/posts/macos-vpn-command-line/>Connect to a VPN from the Command Line on Mac OS</a></li></ul></nav></section><h2>See Also</h2><ul><li><a href=https://4ndrs.xyz/posts/macos-vpn-command-line/>Connect to a VPN from the Command Line on Mac OS</a></li><li><a href=https://4ndrs.xyz/posts/multiple-tool-versions-via-homebrew/>Multiple Tool Versions via Homebrew</a></li><li><a href=https://4ndrs.xyz/posts/nodejs-test-intellij/>JavaScript Testing with Jest in IntelliJ IDEA</a></li></ul><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"4ndrs-xyz"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></section></div><footer class=footer><section class=container>©
2017 -
2020
Andreas Siegel</section></footer></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-431647-14','auto');ga('send','pageview');}</script></body></html>